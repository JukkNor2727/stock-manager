<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Equipment Stock Manager</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root {
      --danger: #ffe5e5;
      --warn: #fffacc;
      --ok: #e7fbe7;
    }
    .row-low { background-color: var(--danger); }
    .row-mid { background-color: var(--warn); }
    .row-ok  { background-color: var(--ok); }
    #loadingSpinner { font-size: 1rem; line-height: 1rem; }
    #overlay.show { opacity: 1; pointer-events: auto; }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-teal-50 to-emerald-100 flex flex-col items-center py-10 px-4">

<script>const SHEETKEY='equipment';</script>

<!-- overlay loading -->
<div id="overlay" class="fixed inset-0 flex items-center justify-center bg-white/60 backdrop-blur-sm opacity-0 pointer-events-none transition-opacity z-50">
  <div class="w-12 h-12 border-4 border-teal-200 border-t-teal-600 rounded-full animate-spin"></div>
</div>

<!-- FORM -->
<div class="w-full max-w-4xl bg-white shadow-2xl rounded-2xl p-6 sm:p-8">
  <h1 class="text-2xl font-bold text-teal-700 text-center mb-6">üì¶ Equipment Stock ‚Äì Add Entry</h1>
  <form id="stockForm" class="grid grid-cols-1 md:grid-cols-2 gap-6" onsubmit="submitForm(event)">
    <div><label class="block text-sm font-medium">Date</label>
      <input id="date" type="date" required class="mt-1 w-full border rounded-xl p-2 focus:outline-none focus:ring">
    </div>
    <div><label class="block text-sm font-medium">Equipment</label>
      <input id="equipment" required class="mt-1 w-full border rounded-xl p-2 focus:outline-none focus:ring">
    </div>
    <div><label class="block text-sm font-medium">Size/Unit</label>
      <input id="sizeUnit" required class="mt-1 w-full border rounded-xl p-2 focus:outline-none focus:ring">
    </div>
    <div><label class="block text-sm font-medium">Brand</label>
      <input id="brand" class="mt-1 w-full border rounded-xl p-2 focus:outline-none focus:ring">
    </div>
    <div><label class="block text-sm font-medium">Received</label>
      <input id="received" type="number" step="any" required class="mt-1 w-full border rounded-xl p-2 focus:outline-none focus:ring">
    </div>
    <div><label class="block text-sm font-medium">Remaining <small class="text-xs text-gray-500">(‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô)</small></label>
      <input id="remaining" type="number" step="any" required class="mt-1 w-full border rounded-xl p-2 focus:outline-none focus:ring">
    </div>
    <div class="md:col-span-2"><label class="block text-sm font-medium">Note</label>
      <textarea id="note" rows="3" class="mt-1 w-full border rounded-xl p-2"></textarea>
    </div>
    <div class="md:col-span-2 flex justify-center mt-4">
      <button id="submitBtn" class="w-full md:w-auto bg-teal-600 hover:bg-teal-700 text-white font-medium px-6 py-2 rounded-xl shadow flex items-center justify-center">
        üíæ Save <span id="loadingSpinner" class="hidden animate-spin ml-2">‚è≥</span>
      </button>
    </div>
  </form>
</div>
<!-- TABLE -->
<div class="w-full max-w-6xl bg-white shadow-2xl rounded-2xl p-4 sm:p-6 mt-10 overflow-x-auto">
  <h2 class="text-xl font-semibold text-teal-700 text-center mb-4">üìã Current Equipment Stock</h2>
  <div class="flex flex-col sm:flex-row items-center justify-between gap-2 px-2 mb-4">
    <input id="searchInput" type="text" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå..." class="border rounded-xl px-4 py-2 w-full sm:max-w-xs text-sm focus:outline-none focus:ring">
    <div class="flex gap-2">
      <button onclick="exportCSV()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-xl shadow text-sm">‚¨áÔ∏è Export CSV</button>
      <button onclick="goHome()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded-xl shadow text-sm">üè† ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</button>
    </div>
  </div>
  <div class="overflow-auto">
    <table class="min-w-full text-center text-sm border border-gray-200">
      <thead class="bg-teal-600 text-white">
        <tr>
          <th class="border p-2">Date</th>
          <th class="border p-2">Equipment</th>
          <th class="border p-2">Size/Unit</th>
          <th class="border p-2">Brand</th>
          <th class="border p-2">Received</th>
          <th class="border p-2">Remaining</th>
          <th class="border p-2">Note</th>
          <th class="border p-2">‡∏•‡∏ö</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>
</div>

<script>
let allRows = [];

function renderTable(dataArr){
  const tbody = document.getElementById('tbody');
  tbody.innerHTML = '';
  if(dataArr.length === 0){
    tbody.innerHTML = '<tr><td colspan="8" class="p-4 text-gray-500">‚ùó ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>';
    return;
  }
  dataArr.forEach(row => {
    const tr = document.createElement('tr');
    tr.className = getRowBgClass(row.remaining);
    tr.innerHTML = `
      <td class="border p-2 break-words">${row.date}</td>
      <td class="border p-2 break-words">${row.equipment}</td>
      <td class="border p-2">${row.sizeUnit}</td>
      <td class="border p-2">${row.brand}</td>
      <td class="border p-2">${row.received}</td>
      <td class="border p-2">
        <div class="flex justify-center items-center gap-1">
          <button onclick="adjustByRowIndex(${row.rowIndex}, 'remaining', ${row.remaining + 1})"
                  class="px-2 bg-green-100 text-green-600 rounded">+</button>
          <span class="${getRemainingClass(row.remaining)} font-semibold px-2">${row.remaining}</span>
          <button onclick="adjustByRowIndex(${row.rowIndex}, 'remaining', ${row.remaining - 1})"
                  class="px-2 bg-red-300 text-red-800 font-bold rounded">‚àí</button>
        </div>
      </td>
      <td class="border p-2 break-words">${row.note}</td>
      <td class="border p-2">
        <button onclick="deleteRow(${row.rowIndex})"
                class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded-xl text-xs">‡∏•‡∏ö</button>
      </td>`;
    tbody.appendChild(tr);
  });
}
</script>
<script>
function submitForm(e){
  e.preventDefault();
  if(!confirm('‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?')) return;

  const data = {
    date: date.value,
    equipment: equipment.value.trim(),
    sizeUnit: sizeUnit.value.trim(),
    brand: brand.value.trim(),
    received: +received.value || 0,
    remaining: +remaining.value || 0,
    note: note.value.trim() || ''
  };

  if(isNaN(data.received) || isNaN(data.remaining)){
    alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á Received ‡πÅ‡∏•‡∏∞ Remaining');
    return;
  }

  submitBtn.disabled = true;
  loadingSpinner.classList.remove('hidden');

  google.script.run
    .withSuccessHandler(()=>{
      alert('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
      stockForm.reset();
      loadTable();
      submitBtn.disabled = false;
      loadingSpinner.classList.add('hidden');
    })
    .withFailureHandler(err=>{
      alert('‚ùå '+err.message);
      submitBtn.disabled = false;
      loadingSpinner.classList.add('hidden');
    })
    .addEquipmentRecord(data);
}

function goHome(){
  google.script.run
    .withSuccessHandler(url => window.top.location.href = url)
    .getHomeUrl();
}

function loadTable(){
  google.script.run
    .withSuccessHandler(rows=>{
      allRows = rows.map((r,i)=>({
        rowIndex: i + 2,
        date: r[0],
        equipment: r[1],
        sizeUnit: r[2],
        brand: r[3],
        received: +r[4] || 0,
        remaining: +r[5] || 0,
        note: r[6] || ''
      }));
      renderTable(allRows);
    })
    .withFailureHandler(err=>alert('‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: '+err.message))
    .getEquipmentData();
}

function adjustByRowIndex(rowIndex, field, newVal){
  const current = allRows.find(r => r.rowIndex === rowIndex)?.[field] || 0;
  const action  = newVal > current ? '‡πÄ‡∏û‡∏¥‡πà‡∏°' : '‡∏•‡∏î';
  if (!confirm(`‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£${action}‡∏Ñ‡πà‡∏≤‡∏à‡∏£‡∏¥‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) return;
  if (newVal < 0) return;

  document.getElementById('overlay')?.classList.add('show');

  const user = localStorage.getItem('currentUser') || 'unknown';

  google.script.run
    .withFailureHandler(err => {
      alert('‚ùå ' + err.message);
      document.getElementById('overlay')?.classList.remove('show');
    })
    .withSuccessHandler(() => {
      loadTable();
      document.getElementById('overlay')?.classList.remove('show');
      alert('‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß!');
    })
    .updateQuantity(SHEETKEY, rowIndex, field, newVal, user);
}

function deleteRow(rowIndex){
  if (!confirm('‚ö†Ô∏è ‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?')) return;

  document.getElementById('overlay')?.classList.add('show');

  google.script.run
    .withSuccessHandler(() => {
      loadTable();
      document.getElementById('overlay')?.classList.remove('show');
      alert('üóëÔ∏è ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß');
    })
    .withFailureHandler(err => {
      alert('‚ùå ' + err.message);
      document.getElementById('overlay')?.classList.remove('show');
    })
    .deleteRecord(SHEETKEY, rowIndex);
}

function getRemainingClass(val){
  if(val <= 1) return 'text-red-600';
  if(val <= 5) return 'text-orange-500';
  return 'text-green-600';
}
function getRowBgClass(val){
  if(val <= 1) return 'row-low';
  if(val <= 5) return 'row-mid';
  return 'row-ok';
}

function searchTable(){
  const kw = searchInput.value.trim().toLowerCase();
  renderTable(!kw ? allRows : allRows.filter(r => r.equipment.toLowerCase().includes(kw)));
}

function exportCSV(){
  const rows = [
    ['Date','Equipment','Size/Unit','Brand','Received','Remaining','Note'],
    ...allRows.map(r => [r.date, r.equipment, r.sizeUnit, r.brand, r.received, r.remaining, r.note])
  ];
  const csv = rows.map(row => row.map(cell => `"${String(cell).replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.setAttribute('download','equipment_stock.csv');
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}

document.addEventListener('DOMContentLoaded', () => {
  loadTable();
  searchInput.addEventListener('input', searchTable);
});
</script>

</body>
</html>
