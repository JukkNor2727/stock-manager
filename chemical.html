<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Chemical Stock Manager</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root {
      --danger: #ffe5e5;
      --warn  : #fffacc;
      --ok    : #e5fbe5;
    }
    .row-low { background-color: var(--danger); }
    .row-mid { background-color: var(--warn);   }
    .row-ok  { background-color: var(--ok);     }
    #overlay.show { opacity: 1; pointer-events: auto; }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-cyan-50 to-emerald-100 text-gray-800 flex flex-col items-center py-6 sm:py-10 px-4">

<script>const SHEETKEY = '%%SHEETKEY%%';</script>

<!-- ‚ñí‚ñí Overlay ‚ñí‚ñí -->
<div id="overlay" class="fixed inset-0 flex items-center justify-center bg-white/60 backdrop-blur-sm opacity-0 pointer-events-none transition-opacity z-50">
  <div class="w-12 h-12 border-4 border-teal-200 border-t-teal-600 rounded-full animate-spin"></div>
</div>

<!-- ‚ñí‚ñí Form ‚ñí‚ñí -->
<div class="w-full max-w-4xl bg-white shadow-2xl rounded-2xl p-6 sm:p-8">
  <h1 class="text-2xl font-bold text-center text-teal-700 mb-6">üìò Chemical Stock ‚Äì Add Entry</h1>

  <form id="stockForm" class="grid grid-cols-1 md:grid-cols-2 gap-6" onsubmit="submitForm(event)">
    <div>
      <label class="block text-sm font-medium">Date</label>
      <input id="date" type="date" required class="mt-1 w-full border rounded-xl p-2 focus:outline-none focus:ring" />
    </div>
    <div>
      <label class="block text-sm font-medium">Chemical</label>
      <input id="chemicals" required class="mt-1 w-full border rounded-xl p-2 focus:outline-none focus:ring" />
    </div>
    <div>
      <label class="block text-sm font-medium">Qty per bottle/drum</label>
      <input id="qtyPerBottle" required class="mt-1 w-full border rounded-xl p-2 focus:outline-none focus:ring" />
    </div>
    <div>
      <label class="block text-sm font-medium">Grade</label>
      <input id="grade" class="mt-1 w-full border rounded-xl p-2 focus:outline-none focus:ring" />
    </div>
    <div>
      <label class="block text-sm font-medium">Qty received</label>
      <input id="qtyReceived" type="number" step="any" required class="mt-1 w-full border rounded-xl p-2 focus:outline-none focus:ring" />
    </div>
    <div>
      <label class="block text-sm font-medium">Remaining qty <small class="text-xs text-gray-500">(‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô)</small></label>
      <input id="qtyRemaining" type="number" step="any" required class="mt-1 w-full border rounded-xl p-2 focus:outline-none focus:ring" />
    </div>
    <div class="md:col-span-2">
      <label class="block text-sm font-medium">Note</label>
      <textarea id="note" rows="3" class="mt-1 w-full border rounded-xl p-2"></textarea>
    </div>
    <div class="md:col-span-2 flex justify-center">
      <button id="submitBtn" class="bg-teal-600 hover:bg-teal-700 text-white font-semibold px-8 py-2 rounded-xl shadow flex items-center">
        üíæ Save <span id="loadingSpinner" class="hidden animate-spin ml-2">‚è≥</span>
      </button>
    </div>
  </form>
</div>
<!-- ‚ñí‚ñí Stock Section ‚ñí‚ñí -->
<div class="w-full max-w-6xl bg-white shadow-2xl rounded-2xl p-4 sm:p-6 mt-10">
  <h2 class="text-xl font-semibold text-center text-teal-700 mb-4 sm:mb-6">üìä Current Chemical Stock</h2>

  <!-- Search & buttons -->
  <div class="flex flex-col sm:flex-row items-center justify-between gap-2 px-1 sm:px-2 mb-4">
    <input id="searchInput" type="text" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ..." class="border rounded-xl px-4 py-2 w-full sm:max-w-xs text-sm focus:outline-none focus:ring" />
    <div class="flex gap-2">
      <button onclick="exportCSV()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-xl text-sm shadow">Export CSV</button>
      <button onclick="goHome()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded-xl text-sm shadow">‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</button>
    </div>
  </div>

  <!-- Card list (mobile) -->
  <div id="cardContainer" class="space-y-3 sm:hidden"></div>

  <!-- Table (desktop) -->
  <div class="hidden sm:block overflow-x-auto">
    <table class="min-w-full text-center text-sm border border-gray-200">
      <thead class="bg-teal-600 text-white">
        <tr>
          <th class="border p-2">Date</th>
          <th class="border p-2">Chemical</th>
          <th class="border p-2">Qty/bottle</th>
          <th class="border p-2">Grade</th>
          <th class="border p-2">Qty received</th>
          <th class="border p-2">Remaining</th>
          <th class="border p-2">Note</th>
          <th class="border p-2">‡∏•‡∏ö</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>
</div>
<script>
let allRows = [];

function submitForm(e){ 
  e.preventDefault();
  if (!confirm('‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?')) return;

  const data = {
    date: date.value,
    chemicals: chemicals.value.trim(),
    qtyPerBottle: qtyPerBottle.value.trim(),
    grade: grade.value.trim(),
    qtyReceived: +qtyReceived.value || 0,
    qtyRemaining: +qtyRemaining.value || 0,
    note: note.value.trim() || ''
  };

  if (isNaN(data.qtyReceived) || isNaN(data.qtyRemaining)) {
    alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á Quantity received ‡πÅ‡∏•‡∏∞ Remaining');
    return;
  }

  submitBtn.disabled = true;
  loadingSpinner.classList.remove('hidden');

  google.script.run
    .withSuccessHandler(() => {
      stockForm.reset();
      loadTable();
      submitBtn.disabled = false;
      loadingSpinner.classList.add('hidden');
      alert('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß!');
    })
    .withFailureHandler(err => {
      alert(err.message);
      submitBtn.disabled = false;
      loadingSpinner.classList.add('hidden');
    })
    .addRecord(SHEETKEY, data);
}

function goHome(){ 
  google.script.run
    .withSuccessHandler(url => window.top.location.href = url)
    .getHomeUrl();
}

function loadTable(){
  google.script.run.withSuccessHandler(rows => {
    allRows = rows.map((r,i)=>({
      rowIndex:i+2,date:r[0],chemicals:r[1],qtyPerBottle:r[2],grade:r[3],
      qtyReceived:+r[4]||0,qtyRemaining:+r[5]||0,note:r[6]||''
    }));
    renderTable(allRows);
  }).getData(SHEETKEY);
}

function renderTable(dataArr){
  const tbody=document.getElementById('tbody');
  tbody.innerHTML='';
  const cardBox=document.getElementById('cardContainer');
  cardBox.innerHTML='';

  if(dataArr.length===0){
    tbody.innerHTML='<tr><td colspan="8" class="p-4 text-gray-500">‚ùó ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>';
    cardBox.innerHTML='<p class="text-center text-gray-500">‚ùó ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>';
    return;
  }

  dataArr.forEach(row=>{
    const tr=document.createElement('tr');
    tr.className=getRowBgClass(row.qtyRemaining);
    tr.innerHTML=`
      <td class="border p-2 break-words">${row.date}</td>
      <td class="border p-2 break-words">${row.chemicals}</td>
      <td class="border p-2">${row.qtyPerBottle}</td>
      <td class="border p-2">${row.grade}</td>
      <td class="border p-2">${row.qtyReceived}</td>
      <td class="border p-2">
        <div class="flex justify-center items-center gap-1">
          <button onclick="adjustByRowIndex(${row.rowIndex},'qtyRemaining',${row.qtyRemaining+1})" class="px-2 bg-green-100 text-green-600 rounded">+</button>
          <span class="${getRemainingClass(row.qtyRemaining)} font-semibold px-2">${row.qtyRemaining}</span>
          <button onclick="adjustByRowIndex(${row.rowIndex},'qtyRemaining',${row.qtyRemaining-1})" class="px-2 bg-red-300 text-red-800 font-bold rounded">‚àí</button>
        </div>
      </td>
      <td class="border p-2 break-words">${row.note}</td>
      <td class="border p-2">
        <button onclick="deleteRow(${row.rowIndex})" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded-xl text-xs">‡∏•‡∏ö</button>
      </td>`;
    tbody.appendChild(tr);

    const card=document.createElement('div');
    card.className=`rounded-xl p-4 shadow border ${getRowBgClass(row.qtyRemaining)} flex flex-col gap-1`;
    card.innerHTML=`<div class="flex justify-between"><span class="font-medium">${row.chemicals}</span><span class="text-xs text-gray-500">${row.date}</span></div>
      <p class="text-sm">üíß <strong>Remaining:</strong> <span class="${getRemainingClass(row.qtyRemaining)}">${row.qtyRemaining}</span></p>
      <p class="text-sm">üì¶ <strong>Received:</strong> ${row.qtyReceived}</p>
      ${row.note?`<p class="text-sm">üìù ${row.note}</p>`:''}
      <div class="mt-2 flex gap-2 justify-end">
        <button class="bg-green-100 text-green-600 px-3 rounded" onclick="adjustByRowIndex(${row.rowIndex},'qtyRemaining',${row.qtyRemaining+1})">+</button>
        <span class="${getRemainingClass(row.qtyRemaining)} font-semibold">${row.qtyRemaining}</span>
        <button class="bg-red-200 text-red-800 px-3 rounded font-bold" onclick="adjustByRowIndex(${row.rowIndex},'qtyRemaining',${row.qtyRemaining-1})">‚àí</button>
        <button class="bg-red-500 text-white px-3 rounded" onclick="deleteRow(${row.rowIndex})">‡∏•‡∏ö</button>
      </div>`;
    cardBox.appendChild(card);
  });
}

function adjustByRowIndex(rowIndex,field,newVal){ 
  const current = allRows.find(r => r.rowIndex === rowIndex)?.[field] || 0;
  const action = newVal > current ? '‡πÄ‡∏û‡∏¥‡πà‡∏°' : '‡∏•‡∏î';
  if (!confirm(`‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£${action}‡∏Ñ‡πà‡∏≤‡∏à‡∏£‡∏¥‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) return;
  if (newVal < 0) return;

  document.getElementById('overlay')?.classList.add('show');

  const user = localStorage.getItem('currentUser') || 'unknown';

  google.script.run
    .withFailureHandler(err => {
      alert('‚ùå ' + err.message);
      document.getElementById('overlay')?.classList.remove('show');
    })
    .withSuccessHandler(() => {
      loadTable();
      document.getElementById('overlay')?.classList.remove('show');
      alert('‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß!');
    })
    .updateQuantity(SHEETKEY, rowIndex, field, newVal, user);
}

function deleteRow(rowIndex){
  if (!confirm('‚ö†Ô∏è ‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?')) return;

  document.getElementById('overlay')?.classList.add('show');

  google.script.run
    .withSuccessHandler(() => {
      loadTable();
      document.getElementById('overlay')?.classList.remove('show');
      alert('üóëÔ∏è ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß');
    })
    .withFailureHandler(err => {
      alert('‚ùå ' + err.message);
      document.getElementById('overlay')?.classList.remove('show');
    })
    .deleteRecord(SHEETKEY, rowIndex);
}

function getRemainingClass(val){
  if(val<=1)return 'text-red-600';
  if(val<=5)return 'text-orange-500';
  return 'text-green-600';
}
function getRowBgClass(val){
  if(val<=1)return 'row-low';
  if(val<=5)return 'row-mid';
  return 'row-ok';
}
function exportCSV(){
  const rows = [
    ['Date','Chemical','Qty/bottle','Grade','Qty received','Remaining','Note'],
    ...allRows.map(r => [r.date, r.chemicals, r.qtyPerBottle, r.grade, r.qtyReceived, r.qtyRemaining, r.note])
  ];
  const csv = rows.map(row => row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(',')).join('\n');
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.setAttribute('download', 'chemical_stock.csv');
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}

document.addEventListener('DOMContentLoaded',()=>{
  loadTable();
  searchInput.addEventListener('input',()=> {
    const kw=searchInput.value.trim().toLowerCase();
    const filtered = !kw ? allRows : allRows.filter(r => r.chemicals.toLowerCase().includes(kw));
    renderTable(filtered);
  });
});
</script>
</body>
</html>
